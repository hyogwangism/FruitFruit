<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shop.fruitfruit.user.UserMapper">
    <!--    회원가입 정보 Insert -->
    <insert id="insertJoin" parameterType="javax.servlet.http.HttpServletRequest">
        INSERT INTO USER VALUES (null, #{id}, #{name}, #{pw}, #{phone}, 1, now())
    </insert>

    <!--    USER_ID 기준으로 회원정보 Select -->
    <select id="selectUser" resultType="HashMap">
        SELECT * FROM USER WHERE USER_EMAIL = #{id}

    </select>

    <!--    회원별 약관동의여부 Insert -->
    <insert id="insertTerm" parameterType="javax.servlet.http.HttpServletRequest">
        INSERT INTO TERM VALUES (null, #{USER_ID_NO}, #{marketing}, #{chk5_Checked}), (null, #{USER_ID_NO}, #{personal_Info}, #{chk6_Checked})
    </insert>


    <select id="loginUserChk" resultType="HashMap">
        SELECT USER_EMAIL, USER_PWD, USER_NAME FROM USER WHERE USER_EMAIL=#{id}

    </select>


    <!--    회원 닉네임 중복여부 -->
    <select id="joinNameChk" resultType="HashMap">
        SELECT USER_NAME FROM USER WHERE USER_NAME=#{name}

    </select>

    <!--    비밀번호 변경 -->
    <update id="updatePw">
        UPDATE USER SET USER_PWD = #{newpw} WHERE USER_EMAIL = #{id}

    </update>

    <!--    USER_ID_NO기준 배송지 정보 저장-->
    <insert id="insertDeliverInfo">
        INSERT INTO USER_DELIVER_INFO VALUES (null, #{USER_ID_NO}, #{deliverPlace}, #{deliverReceiverName}, #{deliverPhone}, #{deliverPostalCode}, #{deliverAddress}, #{deliverRequirement})
    </insert>

    <!--    USER_ID_NO기준 DELIVER_ID 가져오기 -->
    <select id="selectDeliverId" resultType="HashMap">
        SELECT DELIVER_ID FROM USER_DELIVER_INFO WHERE USER_ID_NO=#{USER_ID_NO} ORDER BY DELIVER_ID DESC LIMIT 1;

    </select>

    <!--    DELIEVER_ID 기준 주문 정보 저장-->
    <insert id="insertOrderInfo">
        INSERT INTO ORDER_TABLE VALUES (null, #{DELIVER_ID}, '카드결제', #{cardType}, #{cardName}, #{cardMonthlyInstallments}, #{orderPrice}, NOW(), '미결제')
    </insert>

    <!--    DELIVER_ID 기준 ORDER_ID 가져오기 -->
    <select id="selectOrderId" resultType="HashMap">
        SELECT ORDER_ID FROM ORDER_TABLE WHERE DELIVER_ID=#{DELIVER_ID}

    </select>

    <!--    DELIEVER_ID 기준 주문 정보 저장-->
    <insert id="insertOrderProduct">
        INSERT INTO ORDER_PRODUCT VALUES (null, #{ORDER_ID}, #{productId}, #{productQuantity}, #{productTotalPrice}, '미작성')
    </insert>


    <select id="selectOrderList" resultType="HashMap">
        SELECT UDI.*, OP.*, OT.ORDER_ID, OT.ORDER_DATE, OT.DELIVER_ID, P.PRODUCT_NAME, I.IMAGE_URL
        FROM ORDER_TABLE OT
        JOIN ORDER_PRODUCT OP ON OT.ORDER_ID = OP.ORDER_ID
        JOIN USER_DELIVER_INFO UDI ON OT.DELIVER_ID = UDI.DELIVER_ID
        JOIN PRODUCT P ON OP.PRODUCT_ID = P.PRODUCT_ID
        JOIN IMAGE I ON I.PRODUCT_ID = P.PRODUCT_ID
        <where>

            <if test="startDate != null and endDate != null" >
                AND OT.ORDER_DATE BETWEEN #{startDate} AND #{endDate}
            </if>

            <!-- 이 부분은 searchField 가존재하는 경우 사용됩니다. -->
            <if test="searchType != null and searchType == '상품명' and searchField != null and searchField != ''">
                AND P.PRODUCT_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 이 부분은 searchField 가존재하는 경우 사용됩니다. -->
            <if test="searchType != null and searchType == '주문번호' and searchField != null and searchField != ''">
                AND OT.ORDER_ID LIKE CONCAT('%', #{searchField}, '%')
            </if>

        </where>

        ORDER BY OT.ORDER_ID DESC

    </select>

    <select id="selectOrderProductId" resultType="HashMap">
        SELECT PRODUCT_ID FROM PRODUCT WHERE PRODUCT_NAME=#{order_product_name}
    </select>

</mapper>



