<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shop.fruitfruit.admin.AdminMapper">

    <select id="loginUserChk">
        SELECT * FROM ADMIN_USER WHERE ADMIN_ID=#{id};
    </select>

    <insert id="insertProduct">
        INSERT INTO PRODUCT
        VALUES (NULL, #{productSort}, #{productName}, #{productPrice}, #{productInventory}, #{productDescription}, #{productDiscount}, "판매중", null, NOW())

    </insert>

    <select id="selectProductByProductName" resultType="int">
        SELECT PRODUCT_ID FROM PRODUCT WHERE PRODUCT_NAME=#{productName}

    </select>

    <insert id="insertProductImage" parameterType="java.util.List">
        INSERT INTO IMAGE (PRODUCT_ID, IMAGE_URL, IMAGE_PATH, IMAGE_FILENAME, IMAGE_UPLOADED_AT)
        VALUES
        <foreach collection="list" item="paramMap" separator="," >
            (#{paramMap.productId}, #{paramMap.fireBaseImageUrl}, #{paramMap.fileDBName}, #{paramMap.productName}, now())
        </foreach>
    </insert>

    <select id="selectAllProduct" resultType="HashMap">
        SELECT * FROM PRODUCT ORDER BY PRODUCT_ID DESC
    </select>

    <select id="selectProductByCondition" resultType="HashMap">
        SELECT * FROM PRODUCT
        <where>
            <!-- 이 부분은 조건식이 없을 때 사용됩니다. -->
            <if test="productSaleStatus == 'All' || productSaleStatus == null"></if>
            <if test="productSort == 'All' || productSort == null"></if>
            <!-- 이 부분은 productSaleStatus 조건이 있는 경우 사용됩니다. -->
            <if test="productSaleStatus != null and productSaleStatus != 'All'">
                AND PRODUCT_SALE_STATUS = #{productSaleStatus}
            </if>

            <if test="productSort != null and productSort != 'All'">
                AND CATEGORY_NAME = #{productSort}
            </if>
            <!-- 이 부분은 searchField 가존재하는 경우 사용됩니다. -->
            <if test="searchField != null and searchField != ''">
                AND PRODUCT_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>
        </where>

        ORDER BY PRODUCT_ID DESC
    </select>

    <update id="updateSaleStatusDate">
        UPDATE PRODUCT SET PRODUCT_SALE_STATUS = #{status}, PRODUCT_UPDATED_AT = NOW() WHERE PRODUCT_ID = #{productId}

    </update>

    <select id="updatedSaleStatusDate" resultType="HashMap">
        SELECT * FROM PRODUCT WHERE PRODUCT_ID = #{productId}

    </select>

    <select id="selectProductbyProductId" resultType="HashMap">
        SELECT P.*, I.IMAGE_URL
        FROM PRODUCT P
        LEFT JOIN IMAGE I
        ON P.PRODUCT_ID = I.PRODUCT_ID
        WHERE P.PRODUCT_ID = #{productId}

    </select>

    <select id="selectPicturebyProductId" resultType="HashMap">
        SELECT * FROM image WHERE PRODUCT_ID = #{productId}

    </select>

    <update id="updateProduct">
        UPDATE PRODUCT
        SET
            CATEGORY_NAME = #{productSort}
          , PRODUCT_NAME = #{productName}
          , PRODUCT_PRICE = #{productPrice}
          , PRODUCT_INVENTORY = #{productInventory}
          , PRODUCT_DESCRIPTION = #{productDescription}
          , PRODUCT_DISCOUNT = #{productDiscount}
          , PRODUCT_SALE_STATUS =  "판매중"
          , PRODUCT_UPDATED_AT = null
          , PRODUCT_CREATED_AT = NOW()
        WHERE
            PRODUCT_ID = #{productId}
    </update>

    <update id="updateSalectedSaleStop" parameterType="java.util.HashMap">
        UPDATE PRODUCT
        SET
        PRODUCT_SALE_STATUS =  "판매중지",
        PRODUCT_UPDATED_AT = NOW()
        WHERE
        PRODUCT_ID IN
        <foreach collection="selectedProductId" item="productId" open="(" close=")" separator=",">
            #{productId}
        </foreach>
    </update>

    <select id="selectProductsImage" resultType="HashMap">
        SELECT IMAGE_PATH
        FROM IMAGE
        WHERE
            PRODUCT_ID IN
        <foreach collection="selectedProductId" item="productId" open="(" close=")" separator=",">
            #{productId}
        </foreach>
    </select>

    <!--    리뷰 목록-->
    <select id="selectReview" resultType="HashMap">
        SELECT
            RR.REVIEW_REPLY_CONT, RR.REVIEW_REPLY_DATE,
            R.REVIEW_ID, R.REVIEW_CONT, R.REVIEW_REPLY_STATUS, R.REVIEW_DATE, R.REVIEW_REPLY_STATUS,
            U.USER_NAME, U.USER_EMAIL,
            O.ORDER_ID,
            P.PRODUCT_NAME, P.PRODUCT_ID
        FROM REVIEW R
        LEFT JOIN REVIEW_REPLY RR ON RR.REVIEW_ID = R.REVIEW_ID
        LEFT JOIN USER U ON U.USER_ID_NO = R.USER_ID_NO
        LEFT JOIN ORDER_PRODUCT OP ON OP.ORDER_PRODUCT_ID = R.ORDER_PRODUCT_ID
        LEFT JOIN PRODUCT P ON P.PRODUCT_ID = OP.PRODUCT_ID
        LEFT JOIN ORDER_TABLE O ON O.ORDER_ID = OP.ORDER_ID
        <where>
            <!-- 기본 검색 조건 -->
            <if test="startDate != null and endDate != null">
                AND R.REVIEW_DATE BETWEEN #{startDate} AND #{endDate}
            </if>

            <!-- 상품명 검색 -->
            <if test="searchType != null and searchType == '상품명' and searchField != null and searchField != ''">
                AND P.PRODUCT_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 회원ID 검색 -->
            <if test="searchType != null and searchType == '회원ID' and searchField != null and searchField != ''">
                AND U.USER_EMAIL LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 주문번호 검색 -->
            <if test="searchType != null and searchType == '주문번호' and searchField != null and searchField != ''">
                AND O.ORDER_ID = #{searchField}
            </if>

            <!-- 작성자명 검색 -->
            <if test="searchType != null and searchType == '작성자명' and searchField != null and searchField != ''">
                AND U.USER_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 작성자명 검색 -->
            <if test="REVIEW_ID != null">
                AND R.REVIEW_ID = ${REVIEW_ID}
            </if>

            <!-- 답변 상태 검색 -->
            <if test="replyStatus != null">
                <choose>
                    <when test="replyStatus == '전체'">
                        <!-- 아무 조건 없이 전체 리뷰 검색 -->
                    </when>
                    <when test="replyStatus == '답변완료'">
                        AND (R.REVIEW_REPLY_STATUS = '답변완료' OR R.REVIEW_REPLY_STATUS IS NULL)
                    </when>
                    <when test="replyStatus == '미답변'">
                        AND (R.REVIEW_REPLY_STATUS = '미답변' OR R.REVIEW_REPLY_STATUS IS NULL)
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY R.REVIEW_DATE DESC, R.REVIEW_ID DESC
    </select>

    <!--    리뷰답변 INSERT-->
    <insert id="insertReviewReply">
        INSERT INTO REVIEW_REPLY (REVIEW_ID, REVIEW_REPLY_CONT, REVIEW_REPLY_DATE)
        VALUES (#{REVIEW_ID}, #{REVIEW_REPLY_CONT}, NOW())
    </insert>

    <!--    리뷰답변 상태 UPDATE-->
    <update id="updateReviewStatus">
        UPDATE REVIEW
        SET REVIEW_REPLY_STATUS = '답변완료'
        WHERE REVIEW_ID=#{REVIEW_ID}
    </update>

    <!--    리뷰답변 갯수-->
    <select id="countReview">
    SELECT
    COUNT(*) AS TOTAL_REVIEW_COUNT,
    SUM(CASE WHEN REVIEW_REPLY_STATUS = '미답변' THEN 1 ELSE 0 END) AS UNANSWERED_REVIEW_COUNT,
    SUM(CASE WHEN REVIEW_REPLY_STATUS = '답변완료' THEN 1 ELSE 0 END) AS ANSWERED_REVIEW_COUNT
    FROM REVIEW;
    </select>

    <!--    리뷰 목록 검색결과 갯수-->
    <select id="countSearchReview" resultType="int">
        SELECT
        COUNT(*)
        FROM REVIEW R
        LEFT JOIN REVIEW_REPLY RR ON RR.REVIEW_ID = R.REVIEW_ID
        LEFT JOIN USER U ON U.USER_ID_NO = R.USER_ID_NO
        LEFT JOIN ORDER_PRODUCT OP ON OP.ORDER_PRODUCT_ID = R.ORDER_PRODUCT_ID
        LEFT JOIN PRODUCT P ON P.PRODUCT_ID = OP.PRODUCT_ID
        LEFT JOIN ORDER_TABLE O ON O.ORDER_ID = OP.ORDER_ID
        <where>
            <!-- 기본 검색 조건 -->
            <if test="startDate != null and endDate != null">
                AND R.REVIEW_DATE BETWEEN #{startDate} AND #{endDate}
            </if>

            <!-- 상품명 검색 -->
            <if test="searchType != null and searchType == '상품명' and searchField != null and searchField != ''">
                AND P.PRODUCT_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 회원ID 검색 -->
            <if test="searchType != null and searchType == '회원ID' and searchField != null and searchField != ''">
                AND U.USER_EMAIL LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 주문번호 검색 -->
            <if test="searchType != null and searchType == '주문번호' and searchField != null and searchField != ''">
                AND O.ORDER_ID = #{searchField}
            </if>

            <!-- 작성자명 검색 -->
            <if test="searchType != null and searchType == '작성자명' and searchField != null and searchField != ''">
                AND U.USER_NAME LIKE CONCAT('%', #{searchField}, '%')
            </if>

            <!-- 작성자명 검색 -->
            <if test="REVIEW_ID != null">
                AND R.REVIEW_ID = ${REVIEW_ID}
            </if>

            <!-- 답변 상태 검색 -->
            <if test="replyStatus != null">
                <choose>
                    <when test="replyStatus == '전체'">
                        <!-- 아무 조건 없이 전체 리뷰 검색 -->
                    </when>
                    <when test="replyStatus == '답변완료'">
                        AND (R.REVIEW_REPLY_STATUS = '답변완료' OR R.REVIEW_REPLY_STATUS IS NULL)
                    </when>
                    <when test="replyStatus == '미답변'">
                        AND (R.REVIEW_REPLY_STATUS = '미답변' OR R.REVIEW_REPLY_STATUS IS NULL)
                    </when>
                </choose>
            </if>
        </where>
    </select>
</mapper>

